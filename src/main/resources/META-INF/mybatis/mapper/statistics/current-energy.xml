<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.identity.ems.mapper.statistics.CurrentEnergyMapper">
	<update id="createTable">
	<![CDATA[
        CREATE TABLE IF NOT EXISTS `CURRENT_ENERGY` (
          `BUILDING_BLOCK_IDX` bigint(20) unsigned NOT NULL COMMENT '빌딩 블럭 인덱스',
          `ENERGY_SOURCE_CD` varchar(15) NOT NULL COMMENT '에너지 인덱스',
          `ENERGY_GROUP_CD` varchar(15) NOT NULL COMMENT '에너지 인덱스',
          `ENERGY_IDX` bigint(20) unsigned NOT NULL COMMENT '에너지 인덱스',
          `PERIOD_TYPE_CD` varchar(15) NOT NULL COMMENT '기간 타입',
          `PREVIOUS_TYPE_CD` varchar(15) NOT NULL COMMENT '이전값 타입',
          `DATE` char(8) NOT NULL DEFAULT '' COMMENT '생성날짜',
          `TIME` char(4) NOT NULL DEFAULT '' COMMENT '생성시간',
          `PREVIOUS_VALUE` decimal(20,5) DEFAULT NULL COMMENT '에너지 통계값',
          `VALUE` decimal(20,5) DEFAULT 0.0 COMMENT '에너지 통계값',
          `CREATE_ID` varchar(12) DEFAULT '' COMMENT '생성ID',
          `CREATE_DATE` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '생성날짜',
          `UPDATE_ID` varchar(12) DEFAULT NULL COMMENT '변경ID',
          `UPDATE_DATE` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '변경날짜',
          PRIMARY KEY (`BUILDING_BLOCK_IDX`,`ENERGY_SOURCE_CD`,`ENERGY_GROUP_CD`,`ENERGY_IDX`,`PERIOD_TYPE_CD`,`PREVIOUS_TYPE_CD`)
        ) ENGINE=MEMORY DEFAULT CHARSET=utf8 COMMENT='현재 에너지 통계';
	]]>
	</update>

	<insert id="saveForReal">
	<![CDATA[
    	INSERT INTO CURRENT_ENERGY (
            BUILDING_BLOCK_IDX,
            ENERGY_SOURCE_CD,
            ENERGY_GROUP_CD,
            ENERGY_IDX,
            PERIOD_TYPE_CD,
            PREVIOUS_TYPE_CD,
            DATE,
            TIME,
            PREVIOUS_VALUE,
            VALUE,
            CREATE_ID
        )
        SELECT 	ES.BUID_BLOCK_IX,
                ES.ENERGY_SOURCE_CD,
                EG.ENERGY_SYSTEM_GRP_CD,
                E.ENEG_SYSTEM_MASTER_IX,
                'R',
                '01',
                '${date}',
                '${time}',
                0,
                SER.ENERGY_VALUE,
                'SYSTEM'
        FROM STATISTICS_ENERGY_R_${buildingIdx} AS SER, ENERGY AS E, ENERGY_GROUP AS EG, ENERGY_SOURCE AS ES
        WHERE SER.ENEG_SYSTEM_MASTER_IX = E.ENEG_SYSTEM_MASTER_IX
        AND E.ENEG_SYSTEM_GROUP_IX = EG.ENEG_SYSTEM_GROUP_IX
        AND EG.ENEG_SOURCE_IX = ES.ENEG_SOURCE_IX
        AND SER.DATE = '${date}' AND SER.TIME = '${time}'
        ON DUPLICATE KEY UPDATE
            DATE = '${date}',
        	TIME = '${time}',
        	PREVIOUS_VALUE = VALUE,
        	VALUE = SER.ENERGY_VALUE,
        	UPDATE_DATE = NOW()
	]]>
	</insert>

	<insert id="saveForDay">
	<![CDATA[
    	 INSERT INTO CURRENT_ENERGY (
            BUILDING_BLOCK_IDX,
            ENERGY_SOURCE_CD,
            ENERGY_GROUP_CD,
            ENERGY_IDX,
            PERIOD_TYPE_CD,
            PREVIOUS_TYPE_CD,
            DATE,
            TIME,
            PREVIOUS_VALUE,
            VALUE,
            CREATE_ID
        )
        SELECT * FROM (
            SELECT 	ES.BUID_BLOCK_IX,
                    ES.ENERGY_SOURCE_CD,
                    EG.ENERGY_SYSTEM_GRP_CD,
                    E.ENEG_SYSTEM_MASTER_IX,
                    'D',
                    '01',
                    '${date}',
                    '${time}',
                    0 AS PREVIOUS_VALUE,
                    SUM(SER.ENERGY_VALUE) AS SUM_VALUE,
                    'SYSTEM'
            FROM STATISTICS_ENERGY_R_${buildingIdx} AS SER,
                 ENERGY_GROUP AS EG,
                 ENERGY_SOURCE AS ES,
                 ENERGY AS E
            WHERE SER.ENEG_SYSTEM_MASTER_IX = E.ENEG_SYSTEM_MASTER_IX
            AND E.ENEG_SYSTEM_GROUP_IX = EG.ENEG_SYSTEM_GROUP_IX
            AND EG.ENEG_SOURCE_IX = ES.ENEG_SOURCE_IX
            AND SER.DATE = '${date}'
            GROUP BY ES.BUID_BLOCK_IX, ES.ENERGY_SOURCE_CD, EG.ENERGY_SYSTEM_GRP_CD, E.ENEG_SYSTEM_MASTER_IX ) AS NEW
        ON DUPLICATE KEY UPDATE
            DATE = '${date}',
        	TIME = '${time}',
        	VALUE = NEW.SUM_VALUE,
        	UPDATE_DATE = NOW()
	]]>
	</insert>

	<insert id="saveForPreviousDay">
	<![CDATA[
    	 INSERT INTO CURRENT_ENERGY (
            BUILDING_BLOCK_IDX,
            ENERGY_SOURCE_CD,
            ENERGY_GROUP_CD,
            ENERGY_IDX,
            PERIOD_TYPE_CD,
            PREVIOUS_TYPE_CD,
            DATE,
            TIME,
            PREVIOUS_VALUE,
            VALUE,
            CREATE_ID
        )
  		SELECT * FROM (
            SELECT 	ES.BUID_BLOCK_IX,
                    ES.ENERGY_SOURCE_CD,
                    EG.ENERGY_SYSTEM_GRP_CD,
                    E.ENEG_SYSTEM_MASTER_IX,
                    'D',
                    '01',
                    '${date}',
                    '${time}',
                    SEP.ENERGY_SUM AS PREVIOUS_VALUE,
                    0,
                    'SYSTEM'
            FROM STATISTICS_ENERGY_P_${buildingIdx} AS SEP,
                 ENERGY_GROUP AS EG,
                 ENERGY_SOURCE AS ES,
                 ENERGY AS E
            WHERE SEP.ENEG_SYSTEM_MASTER_IX = E.ENEG_SYSTEM_MASTER_IX
            AND SEP.PERIOD_TYPE_CD ='D'
            AND E.ENEG_SYSTEM_GROUP_IX = EG.ENEG_SYSTEM_GROUP_IX
            AND EG.ENEG_SOURCE_IX = ES.ENEG_SOURCE_IX
            AND SEP.DATE = '${date}' ) AS NEW
        ON DUPLICATE KEY UPDATE
            DATE = '${date}',
        	TIME = '${time}',
        	PREVIOUS_VALUE = NEW.PREVIOUS_VALUE,
        	UPDATE_DATE = NOW()
	]]>
	</insert>

</mapper>
