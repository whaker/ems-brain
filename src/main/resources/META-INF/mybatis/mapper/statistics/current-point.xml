<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.identity.ems.mapper.statistics.CurrentPointMapper">

	<update id="createTable">
	<![CDATA[
        CREATE TABLE IF NOT EXISTS `CURRENT_POINT` (
          `POIT_LIST_IX` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '포인트정보 시퀀스',
          `BEFORE_POINT_VALUE` decimal(20,2) DEFAULT NULL COMMENT '포인트 변화값',
          `POINT_VALUE` decimal(20,2) DEFAULT 0.0 COMMENT '포인트 측정값',
          `REAL_POINT_VALUE` decimal(20,2) DEFAULT 0.0 COMMENT '포인트 측정값',
          `CREATE_ID` varchar(12) DEFAULT '' COMMENT '생성ID',
          `CREATE_DATE` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '생성날짜',
          `UPDATE_ID` varchar(12) DEFAULT NULL COMMENT '변경ID',
          `UPDATE_DATE` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '변경날짜',
          PRIMARY KEY (`POIT_LIST_IX`)
        ) ENGINE=MyISAM DEFAULT CHARSET=utf8 COMMENT='현재 포인트 값';
	]]>
	</update>

	<insert id="upsert">
	<![CDATA[
		INSERT INTO CURRENT_POINT (
            POIT_LIST_IX,
            BEFORE_POINT_VALUE,
            POINT_VALUE,
            REAL_POINT_VALUE,
            CREATE_ID)
		SELECT SPR.POIT_LIST_IX,
			   IFNULL(SPR.POINT_VALUE,0.0) AS BEFORE_POINT_VALUE,
			   IFNULL(SPR.POINT_VALUE,0.0) AS POINT_VALUE,
			   (CASE WHEN PL.POINT_VALUE_TYPE_CD = '01'
					 THEN IFNULL(SPR.POINT_VALUE,0.0)
					 ELSE IFNULL(SPR.POINT_CHANGE_VALUE,0.0)
					 END) AS REAL_POINT_VALUE,
					 'SYSTREM'
		FROM STATISTICS_POINT_R_${buildingIdx} AS SPR,
			 POINT AS PL
			 LEFT JOIN CURRENT_POINT PC ON (PC.POIT_LIST_IX = PL.POIT_LIST_IX)
		WHERE SPR.POIT_LIST_IX = PL.POIT_LIST_IX
		AND SPR.DATE = ${date} AND SPR.TIME = ${time}
		ON DUPLICATE KEY UPDATE
			BEFORE_POINT_VALUE = PC.POINT_VALUE,
			POINT_VALUE = SPR.POINT_VALUE,
			REAL_POINT_VALUE = (
				CASE WHEN PL.POINT_VALUE_TYPE_CD = '01'
				THEN IFNULL(SPR.POINT_VALUE,0.0)
				ELSE IFNULL(SPR.POINT_CHANGE_VALUE,0.0)
				END),
			UPDATE_DATE = NOW()
	]]>
	</insert>
	
</mapper>
